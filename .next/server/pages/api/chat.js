"use strict";(()=>{var e={};e.id=170,e.ids=[170],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2079:e=>{e.exports=import("openai")},6555:e=>{e.exports=import("uuid")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,o){return o in t?t[o]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,o)):"function"==typeof t&&"default"===o?t:void 0}}})},8653:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{config:()=>u,default:()=>d,routeModule:()=>p});var s=o(1802),n=o(7153),a=o(6249),i=o(895),l=e([i]);i=(l.then?(await l)():l)[0];let d=(0,a.l)(i,"default"),u=(0,a.l)(i,"config"),p=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/chat",pathname:"/api/chat",bundlePath:"",filename:""},userland:i});r()}catch(e){r(e)}})},895:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{default:()=>p});var s=o(2885),n=o(6555),a=o(2079),i=o(8801),l=e([n,a]);[n,a]=l.then?(await l)():l;let c=(0,s.createClient)(process.env.SUPABASE_URL||"",process.env.SUPABASE_ANON_KEY||""),m=process.env.OPENAI_API_KEY?new a.default({apiKey:process.env.OPENAI_API_KEY}):null,y=["That’s a plot twist I didn’t see coming… but let’s stick to your debts, yeah?","I’m flattered you think I can do that — let’s get you debt-free instead!","As fun as that sounds, I’m here to help with money stress — not become your life coach. Yet."];async function d(e){let{data:t}=await c.from("chat_sessions").select("step_index").eq("session_id",e).maybeSingle();return t?.step_index??0}async function u(e,t){await c.from("chat_sessions").upsert({session_id:e,step_index:t})}async function p(e,t){if("POST"!==e.method)return t.status(405).end();try{let o;let r=i.steps;if(!r||0===r.length)return t.status(500).json({reply:"Script not configured."});let s=String(e.body?.message??"").trim();if(!s)return t.status(400).json({reply:"Please type a message to continue."});let a=String(e.body?.sessionId||(0,n.v4)()),l=s.replace(/[\u{1F44B}]/gu,"").trim().toLowerCase();if("initiate"===l||"start"===l||"restart"===l)return await u(a,0),t.status(200).json({reply:r[0].prompt,sessionId:a});let p=await d(a);(p<0||p>=r.length)&&(p=0);let c=r[p],h=function(e,t){let o=e.toLowerCase().trim();if(("total_amount"===t.id||"amount"===t.id||"fact_find_total"===t.id)&&function(e){let t=e.toLowerCase();return!!(/[£$€]\s*\d/.test(t)||/\b\d{2,}\b/.test(t)||/\b\d+(\.\d+)?\s*k\b/.test(t)||/\b(thousand|k)\b/.test(t))}(o))return!0;let r=(t.keywords||[]).map(e=>e.toLowerCase());return 0===r.length?o.length>0:r.some(e=>o.includes(e))}(s,c),f=p;if(h)f=Math.min(p+1,r.length-1),o=r[f].prompt;else{let e=i.humor_fallbacks&&i.humor_fallbacks.length?i.humor_fallbacks:y,t=e[Math.floor(Math.random()*e.length)];o=`${t} ${c.prompt}`}if(await u(a,f),m)try{let e=await m.chat.completions.create({model:f>6?"gpt-4o":"gpt-3.5-turbo",temperature:.4,messages:[{role:"system",content:"You are Mark, a professional, friendly UK debt advisor. Keep replies concise, clear, and compliant. If humour is present, keep it light and professional. Do not skip steps."},{role:"user",content:`Polish this assistant reply without changing meaning: "${o}"`}]});o=e.choices[0]?.message?.content?.trim()||o}catch{}return t.status(200).json({reply:o,sessionId:a})}catch(e){return console.error("chat.ts error:",e?.message||e),t.status(500).json({reply:"Sorry, something went wrong on my end. Please try again."})}}r()}catch(e){r(e)}})},7153:(e,t)=>{var o;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(e,t,o)=>{e.exports=o(145)},8801:e=>{e.exports=JSON.parse('{"steps":[{"id":"intro","prompt":"Hello! My name’s Mark. What prompted you to seek help with your debts today?","keywords":["debt","help","struggling","bailiff","bailiffs","interest","court","credit","loan","cards"]},{"id":"total_amount","prompt":"Thanks for sharing. Roughly how much do you owe in total across all debts?","keywords":["\xa3","k","thousand","1000","2000","5000","10000"]},{"id":"creditors_count","prompt":"Got it. And is this with at least two different unsecured creditors like credit cards or loans?","keywords":["yes","2","two","more than one","multiple","barclaycard","capital one","mbna","hsbc","lloyds"]},{"id":"joint_or_guarantor","prompt":"Are any of your debts joint with someone else, or is anyone a guarantor (or are you a guarantor for someone)?","keywords":["yes","no","joint","guarantor","partner","spouse"]},{"id":"employment_income","prompt":"Thanks. What’s your employment situation and approximate monthly income after tax?","keywords":["job","employed","self","self-employed","benefits","income","salary","wage","earn"]},{"id":"housing_costs","prompt":"What are your monthly housing costs (rent or mortgage) and utility bills roughly?","keywords":["rent","mortgage","housing","utilities","bills"]},{"id":"assets_vehicle","prompt":"Do you own any assets such as a home with equity or a vehicle? If so, roughly what are they worth?","keywords":["car","vehicle","house","home","equity","no assets","none"]},{"id":"options_overview","prompt":"Here are your main options. I’ll explain each briefly so you can decide: self-help, consolidation loan, DRO (if eligible), Bankruptcy, DMP, and IVA. Ready for a quick run-through?","keywords":["yes","ok","ready","go ahead","explain"]},{"id":"iva_explain","prompt":"IVA: legally binding, usually 5–6 years. You pay what’s affordable; remaining unsecured debt may be written off. Protects from most creditor action.","keywords":["ok","understand","iva","sounds good","tell me more"]},{"id":"dmp_explain","prompt":"DMP: informal plan to repay what you owe over time. Interest/charges can be reduced or frozen but not guaranteed.","keywords":["ok","understand","dmp","sounds good"]},{"id":"other_explain","prompt":"Other routes include self-help (talk to creditors directly), consolidation (if credit is good), DRO (low assets/low income), or Bankruptcy (last resort).","keywords":["ok","understand","got it","thanks"]},{"id":"document_upload","prompt":"Next step: we’ll need documents (ID, proof of income, and creditor details). Are you ready to upload now? If not, I’ll send you a secure portal link.","keywords":["yes","ready","not yet","send link","later"]},{"id":"end","prompt":"Brilliant — I’ll guide you through the portal. I’m here if you need anything else!","keywords":[]}],"humor_fallbacks":["That’s a plot twist I didn’t see coming… but let’s stick to sorting your finances!","I’m flattered — but let’s keep the focus on getting you debt-free. \uD83D\uDCAA","If the aliens return your payslip, upload it — meanwhile, let’s keep going."]}')}};var t=require("../../webpack-api-runtime.js");t.C(e);var o=t(t.s=8653);module.exports=o})();