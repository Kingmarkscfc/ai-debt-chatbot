"use strict";(()=>{var e={};e.id=170,e.ids=[170],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2079:e=>{e.exports=import("openai")},6555:e=>{e.exports=import("uuid")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},8653:(e,t,s)=>{s.a(e,async(e,o)=>{try{s.r(t),s.d(t,{config:()=>d,default:()=>l,routeModule:()=>p});var r=s(1802),a=s(7153),n=s(6249),i=s(895),u=e([i]);i=(u.then?(await u)():u)[0];let l=(0,n.l)(i,"default"),d=(0,n.l)(i,"config"),p=new r.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/chat",pathname:"/api/chat",bundlePath:"",filename:""},userland:i});o()}catch(e){o(e)}})},895:(e,t,s)=>{s.a(e,async(e,o)=>{try{s.r(t),s.d(t,{default:()=>l});var r=s(2079),a=s(2885),n=s(6555),i=s(8801),u=e([r,n]);[r,n]=u.then?(await u)():u;let d=new r.default({apiKey:process.env.OPENAI_API_KEY}),p=(0,a.createClient)(process.env.SUPABASE_URL||"",process.env.SUPABASE_ANON_KEY||""),c=["That’s a plot twist I didn’t see coming… but let’s stick to your debts, yeah?","I’m flattered you think I can do that, but let’s get back to helping you become debt-free!","As fun as that sounds, I’m here to help with your money stress, not become your life coach. Yet."];async function l(e,t){if("POST"!==e.method)return t.status(405).end();try{if(!e.body||"string"!=typeof e.body.message)return console.error("400 Error: Invalid request body",e.body),t.status(400).json({reply:"Invalid request format."});let s=e.body.message.trim(),o=e.body.sessionId||(0,n.v4)(),{data:r}=await p.from("chat_history").select("messages").eq("session_id",o).single(),a=[];if("\uD83D\uDC4B INITIATE"===s){let e=i.S[0]?.prompt||"Hello, my name is Mark. What language would you like to use today so I can best help you with your debts?";return a=[{role:"assistant",content:e}],await p.from("chat_history").upsert({session_id:o,messages:a}),t.status(200).json({reply:e,sessionId:o})}r?.messages&&(a=r.messages),a.push({role:"user",content:s});let u=a.filter(e=>"user"===e.role).length,l=a.filter(e=>"assistant"===e.role).length,h=i.S[Math.min(u,l)]||i.S[i.S.length-1],m=h?.prompt||"Let’s keep going with your debt help...",y=await d.chat.completions.create({model:a.length>12?"gpt-4o":"gpt-3.5-turbo",messages:[{role:"system",content:"You are a professional and friendly AI debt advisor named Mark. Follow the IVA script strictly step-by-step using the provided script logic. NEVER skip ahead. If the user goes off-topic, bring them back using professional humour. Only use humour for off-topic replies. Do not loop or repeat past steps."},...a,{role:"assistant",content:m}],temperature:.7}),f=y.choices[0].message.content?.trim()||"I'm not sure how to reply to that.";return(f.toLowerCase().includes("i don't understand")||f.toLowerCase().includes("i'm not sure"))&&(f=c[Math.floor(Math.random()*c.length)]),a.push({role:"assistant",content:f}),await p.from("chat_history").upsert({session_id:o,messages:a}),t.status(200).json({reply:f,sessionId:o})}catch(e){return console.error("500 Error in /api/chat:",e.message||e),t.status(500).json({reply:"Sorry, something went wrong on my end. Please try again shortly."})}}o()}catch(e){o(e)}})},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)},8801:e=>{e.exports=JSON.parse('{"S":[{"prompt":"Hello! My name’s Mark. What prompted you to seek help with your debts today?","keywords":["debt","help","struggling","money","bailiffs"]},{"prompt":"Let’s take a look at your total debt amount. Roughly how much do you owe in total?","keywords":["\xa3","pounds","thousand","hundred"]},{"prompt":"Thanks. And is this with at least two different unsecured creditors like credit cards or loans?","keywords":["yes","2","two","creditors","loans","cards"]}]}')}};var t=require("../../webpack-api-runtime.js");t.C(e);var s=t(t.s=8653);module.exports=s})();