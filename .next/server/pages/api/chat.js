"use strict";(()=>{var e={};e.id=170,e.ids=[170],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2079:e=>{e.exports=import("openai")},6555:e=>{e.exports=import("uuid")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,o){return o in t?t[o]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,o)):"function"==typeof t&&"default"===o?t:void 0}}})},8653:(e,t,o)=>{o.a(e,async(e,s)=>{try{o.r(t),o.d(t,{config:()=>d,default:()=>u,routeModule:()=>p});var r=o(1802),a=o(7153),n=o(6249),i=o(895),l=e([i]);i=(l.then?(await l)():l)[0];let u=(0,n.l)(i,"default"),d=(0,n.l)(i,"config"),p=new r.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/chat",pathname:"/api/chat",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},895:(e,t,o)=>{o.a(e,async(e,s)=>{try{o.r(t),o.d(t,{default:()=>u});var r=o(2079),a=o(2885),n=o(6555),i=o(5600),l=e([r,n]);[r,n]=l.then?(await l)():l;let d=new r.default({apiKey:process.env.OPENAI_API_KEY}),p=(0,a.createClient)(process.env.SUPABASE_URL||"",process.env.SUPABASE_ANON_KEY||""),c=["That’s a plot twist I didn’t see coming… but let’s stick to your debts, yeah?","I’m flattered you think I can do that, but let’s get back to helping you become debt-free!","As fun as that sounds, I’m here to help with your money stress, not become your life coach. Yet."];async function u(e,t){if("POST"!==e.method)return t.status(405).end();try{if(!e.body||"string"!=typeof e.body.message)return console.error("400 Error: Invalid request body",e.body),t.status(400).json({reply:"Invalid request format."});let o=e.body.message.trim(),s=e.body.sessionId||(0,n.v4)(),{data:r}=await p.from("chat_history").select("messages").eq("session_id",s).single(),a=[];if("\uD83D\uDC4B INITIATE"===o){let e=i.S[0]?.prompt||"Hello, my name is Mark. What language would you like to use today so I can best help you with your debts?";return a=[{role:"assistant",content:e}],await p.from("chat_history").upsert({session_id:s,messages:a}),t.status(200).json({reply:e,sessionId:s})}r?.messages&&(a=r.messages),a.push({role:"user",content:o});let l=a.filter(e=>"user"===e.role).length,u=a.filter(e=>"assistant"===e.role).length,h=i.S[Math.min(l,u)]||i.S[i.S.length-1],m=h?.prompt||"Let’s keep going with your debt help...",y=await d.chat.completions.create({model:a.length>12?"gpt-4o":"gpt-3.5-turbo",messages:[{role:"system",content:"You are a professional and friendly AI debt advisor named Mark. Follow the IVA script strictly step-by-step using the provided script logic. NEVER skip ahead. If the user goes off-topic, bring them back using professional humour. Only use humour for off-topic replies. Do not loop or repeat past steps."},...a,{role:"assistant",content:m}],temperature:.7}),f=y.choices[0].message.content?.trim()||"I'm not sure how to reply to that.";return(f.toLowerCase().includes("i don't understand")||f.toLowerCase().includes("i'm not sure"))&&(f=c[Math.floor(Math.random()*c.length)]),a.push({role:"assistant",content:f}),await p.from("chat_history").upsert({session_id:s,messages:a}),t.status(200).json({reply:f,sessionId:s})}catch(e){return console.error("500 Error in /api/chat:",e.message||e),t.status(500).json({reply:"Sorry, something went wrong on my end. Please try again shortly."})}}s()}catch(e){s(e)}})},7153:(e,t)=>{var o;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(e,t,o)=>{e.exports=o(145)},5600:e=>{e.exports=JSON.parse('{"S":[{"id":"start","prompt":"Hello! My name’s Mark. What prompted you to seek help with your debts today?","next":"main_concern"},{"id":"main_concern","prompt":"Thank you for telling me that. What would you say is your main concern with the debts? For example, is it bailiffs, interest, or court action?","next":"joint_guarantor"},{"id":"joint_guarantor","prompt":"Are any of your debts in joint names with anybody else, or is anyone a guarantor for your debts—or are you a guarantor for someone else?","next":"self_help"},{"id":"self_help","prompt":"Let’s go through the options to deal with your debts. The first is a self-help approach. This involves speaking to creditors yourself to arrange payments or freeze interest.","next":"loan_consolidation"},{"id":"loan_consolidation","prompt":"Next is loan consolidation. This means taking out a single loan to repay multiple debts. It’s only suitable for people with a good credit score and affordability.","next":"dro"},{"id":"dro","prompt":"Now we’ll look at a Debt Relief Order (DRO). This is a formal debt solution for people with low income, low assets, and debts under a certain limit.","next":"bankruptcy"},{"id":"bankruptcy","prompt":"Let’s look at Bankruptcy. It clears most debts after 12 months but has serious consequences. Your assets may be sold and it stays on your credit file for 6 years.","next":"dmp"},{"id":"dmp","prompt":"Another option is a Debt Management Plan (DMP). This is an informal plan where you pay back what you owe over time. Interest can sometimes be frozen, but not always.","next":"iva"},{"id":"iva","prompt":"Finally, there’s an Individual Voluntary Arrangement (IVA). This is a legally binding solution where you pay back what you can afford for 5–6 years, and the rest is written off.","next":"document_upload"},{"id":"document_upload","prompt":"Based on what we’ve discussed, I can help you prepare documents for the next step. We’ll need proof of income, debts, and ID. Are you ready to upload those now?","next":"end"},{"id":"end","prompt":"Thanks for going through the options. You can upload your documents securely via your online portal. I’m here if you need help at any time!","next":null}]}')}};var t=require("../../webpack-api-runtime.js");t.C(e);var o=t(t.s=8653);module.exports=o})();